<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Graph Overlay on Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <!-- Bootstrap CSS for modern UI -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .header h2 {
            margin: 0;
            font-weight: 700;
        }
        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        .content-wrapper {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 20px;
        }
        #map { 
            width: 100%; 
            height: 600px; 
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
            border: none;
        }
        .card-body {
            padding: 15px;
        }
        .legend {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            font-size: 0.95em;
        }
        .legend-item:last-child {
            margin-bottom: 0;
        }
        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
            flex-shrink: 0;
        }
        .legend-line {
            display: flex;
            align-items: center;
            margin-right: 10px;
            flex-shrink: 0;
        }
        .controls-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .btn-group-vertical {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .btn {
            border-radius: 8px;
            font-weight: 600;
            padding: 10px 15px;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .btn-success {
            background: #28a745;
            border-color: #28a745;
        }
        .btn-danger {
            background: #dc3545;
            border-color: #dc3545;
        }
        .btn-warning {
            background: #ffc107;
            border-color: #ffc107;
            color: #333;
        }
        .btn-secondary {
            background: #6c757d;
            border-color: #6c757d;
        }
        .instructions {
            background: #e7f1ff;
            border-left: 4px solid #667eea;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        .instructions h5 {
            color: #667eea;
            margin-bottom: 10px;
            font-weight: 600;
        }
        .instructions ol {
            margin: 0;
            padding-left: 20px;
            font-size: 0.95em;
        }
        .instructions li {
            color: #333;
            margin-bottom: 6px;
        }
        .spinner-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            display: none;
        }
        @media (max-width: 1024px) {
            .content-wrapper {
                grid-template-columns: 1fr;
            }
            .sidebar {
                flex-direction: row;
            }
        }
    </style>
</head>
<body class="bg-light">
    <div class="header">
        <div class="main-container">
            <h2>üìç Route Optimization Interface</h2>
        </div>
    </div>

    <div class="main-container">
        <div class="instructions">
            <h5>üìñ How to Use This Tool:</h5>
            <ol>
                <li><strong>View the Map:</strong> All street intersections (nodes) are shown as red dots connected by blue lines</li>
                <li><strong>Select Nodes:</strong> Click on any red dot to select it (it will turn yellow)</li>
                <li><strong>Set Start Point:</strong> Select a starting node and click "Set as Start" (it will turn green)</li>
                <li><strong>Delete Nodes (Optional):</strong> Select multiple nodes and click "Delete Selected Nodes" to exclude them from the route</li>
                <li><strong>Optimize Route:</strong> Click "Optimize Route" to calculate the shortest path visiting all selected nodes</li>
                <li><strong>View Results:</strong> Once optimized, red lines show the final route. Blue lines indicate segments you'll travel twice</li>
                <li><strong>Get Directions:</strong> Click "View Directions" for turn-by-turn navigation</li>
            </ol>
        </div>

        <div class="content-wrapper">
            <div>
                <div id="map" class="mb-3"></div>
                <div class="controls-section">
                    <div class="btn-group-vertical">
                        <button id="set-start-btn" class="btn btn-success" disabled>üìç Set as Start</button>
                        <button id="optimize-btn" class="btn btn-danger" disabled>‚ö° Optimize Route</button>
                        <button id="view-directions-btn" class="btn btn-warning" style="display:none">üó∫Ô∏è View Directions</button>
                        <button id="delete-btn" class="btn btn-secondary" disabled>üóëÔ∏è Delete Selected Nodes</button>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="sidebar">
                <div class="card legend">
                    <div class="card-header">
                        Legend
                    </div>
                    <div class="card-body">
                        <div class="legend-item">
                            <div class="legend-dot" style="background-color: #FF4136;"></div>
                            <span>Regular Node</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-dot" style="background-color: #FFD700;"></div>
                            <span>Selected Node</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-dot" style="background-color: #2ECC40;"></div>
                            <span>Start Node</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-dot" style="background-color: #0074D9;"></div>
                            <span>End Node / Backtrack</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-line">
                                <div style="height: 3px; width: 20px; background-color: #d1001f; font-weight: bold;"></div>
                            </div>
                            <span>Optimized Route</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-line">
                                <div style="height: 3px; width: 20px; background-color: #0074D9; font-weight: bold;"></div>
                            </div>
                            <span>Doubled-back Segment</span>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        Tips
                    </div>
                    <div class="card-body" style="font-size: 0.9em;">
                        <ul style="margin: 0; padding-left: 18px;">
                            <li>Click nodes on the map to select/deselect them</li>
                            <li>The optimization calculates the shortest Eulerian path</li>
                            <li>Blue lines show streets you'll traverse twice</li>
                            <li>Route planning uses real street data</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer with Credits -->
    <footer style="background: white; border-top: 1px solid #ddd; padding: 20px; text-align: center; margin-top: 30px; font-size: 0.85em; color: #666;">
        <p style="margin: 5px 0;">
            <a href="#" onclick="showCredits(event)" style="color: #667eea; text-decoration: none; cursor: pointer;">Credits & Attribution</a>
        </p>
        <p style="margin: 5px 0; font-size: 0.8em;">¬© 2026 Food Truck Route Optimizer | Built with open-source technologies</p>
    </footer>

    <!-- Credits Modal -->
    <div id="creditsModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 10px; padding: 30px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
            <h3 style="color: #333; margin-top: 0;">Credits & Attribution</h3>
            <p style="color: #666; line-height: 1.6;">This project uses the following excellent open-source technologies and services:</p>
            
            <h5 style="color: #667eea; margin-top: 20px; margin-bottom: 10px;"> Mapping & Routing</h5>
            <ul style="color: #666; margin-left: 20px; line-height: 1.8;">
                <li><strong>Leaflet.js</strong> - Interactive maps library (BSD 2-Clause License)</li>
                <li><strong>OpenStreetMap</strong> - Free map data and tiles (ODbL License)</li>
                <li><strong>OSRM (Open Source Routing Machine)</strong> - Route optimization engine (AGPL-3.0 License)</li>
                <li><strong>Nominatim</strong> - Free geocoding service (ODbL License)</li>
            </ul>

            <h5 style="color: #667eea; margin-top: 20px; margin-bottom: 10px;"> UI & Frontend</h5>
            <ul style="color: #666; margin-left: 20px; line-height: 1.8;">
                <li><strong>Bootstrap 5</strong> - CSS framework (MIT License)</li>
                <li><strong>D3.js</strong> - Data visualization library (ISC License)</li>
            </ul>

            <h5 style="color: #667eea; margin-top: 20px; margin-bottom: 10px;"> Backend</h5>
            <ul style="color: #666; margin-left: 20px; line-height: 1.8;">
                <li><strong>Flask</strong> - Web framework (BSD License)</li>
                <li><strong>NetworkX</strong> - Graph library (BSD License)</li>
                <li><strong>GeoPy</strong> - Geolocation library (MIT License)</li>
                <li><strong>Overpass API</strong> - OpenStreetMap data queries</li>
            </ul>

            <h5 style="color: #667eea; margin-top: 20px; margin-bottom: 10px;"> Data</h5>
            <ul style="color: #666; margin-left: 20px; line-height: 1.8;">
                <li><strong>OpenStreetMap Contributors</strong> - Street data (ODbL License)</li>
                <li><strong>Humanitarian Data Exchange</strong> - OSM.pbf data</li>
            </ul>

            <h5 style="color: #667eea; margin-top: 20px; margin-bottom: 10px;"> Special Thanks</h5>
            <p style="color: #666; margin: 10px 0; line-height: 1.8;">
                This application is built on the work of countless open-source contributors. We are grateful for their dedication and innovation.
            </p>

            <button onclick="closeCredits()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; margin-top: 20px; font-weight: 600;">Close</button>
        </div>
    </div>

    <!-- Spinner overlay -->
    <div class="spinner-overlay" id="spinner-overlay">
        <div class="spinner-border text-primary" role="status" style="width: 4rem; height: 4rem;">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const boundaryId = "{{ boundary_id }}";
        const map = L.map('map').setView([0, 0], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '¬© OpenStreetMap'
        }).addTo(map);

        let selectedNodeIds = [];
        let selectedNodeId = null;
        let startNodeId = null;
        let nodeMarkers = {};
        let routePolyline = null;

        function updateMarkerStyles() {
            Object.entries(nodeMarkers).forEach(([id, marker]) => {
                const nodeId = parseInt(id, 10);
                if (nodeId === startNodeId) {
                    marker.setStyle({fillColor: "#2ECC40"});
                } else if (selectedNodeIds.includes(nodeId)) {
                    marker.setStyle({fillColor: "#FFD700"});
                } else {
                    marker.setStyle({fillColor: "#FF4136"});
                }
            });
        }

        function onNodeClick(e, nodeId) {
            selectedNodeId = nodeId;
            document.getElementById('set-start-btn').disabled = false;
            const idx = selectedNodeIds.indexOf(nodeId);
            if (idx === -1) {
                selectedNodeIds.push(nodeId);
            } else {
                selectedNodeIds.splice(idx, 1);
            }
            updateMarkerStyles();
            document.getElementById('delete-btn').disabled = selectedNodeIds.length === 0;
        }

        fetch(`/graph-data?boundary_id=${boundaryId}`)
            .then(response => response.json())
            .then(function(data) {
                if (data.nodes.length > 0) {
                    map.setView([data.nodes[0].lat, data.nodes[0].lon], 16);
                }
                data.links.forEach(function(link) {
                    const source = data.nodes.find(function(n) { return n.id === link.source; });
                    const target = data.nodes.find(function(n) { return n.id === link.target; });
                    if (source && target) {
                        L.polyline([[source.lat, source.lon], [target.lat, target.lon]], {color: '#0074D9', weight: 4, opacity: 0.7}).addTo(map);
                    }
                });
                data.nodes.forEach(function(node) {
                    const marker = L.circleMarker([node.lat, node.lon], {
                        radius: 6,
                        fillColor: "#FF4136",
                        color: "#fff",
                        weight: 1,
                        opacity: 1,
                        fillOpacity: 0.9
                    }).addTo(map);
                    marker.on('click', function(e) { onNodeClick(e, node.id); });
                    nodeMarkers[node.id] = marker;
                });
            });

        document.getElementById('delete-btn').onclick = function() {
            fetch('/delete_nodes', {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({boundary_id: boundaryId, nodes: selectedNodeIds})})
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.reload();
                } else {
                    alert(data.error || "Could not delete nodes.");
                }
            });
        };

        document.getElementById('set-start-btn').onclick = function() {
            startNodeId = selectedNodeId;
            updateMarkerStyles();
            document.getElementById('set-start-btn').disabled = true;
            checkReady();
        };

        function checkReady() {
            document.getElementById('optimize-btn').disabled = !startNodeId;
        }

        function showSpinner() {
            document.getElementById('spinner-overlay').style.display = 'flex';
        }

        function hideSpinner() {
            document.getElementById('spinner-overlay').style.display = 'none';
        }

        document.getElementById('optimize-btn').onclick = function() {
            if (!startNodeId) {
                alert('Please select a start node first.');
                return;
            }
            showSpinner();
            fetch(`/visualize_cpp?boundary_id=${boundaryId}&start_node=${startNodeId}`)
                .then(response => {
                    hideSpinner();
                    if (!response.ok) {
                        alert('Failed to fetch route.');
                        return Promise.reject();
                    }
                    return response.json();
                })
                .then(function(data) {
                    if (!data || !data.route || data.route.length < 2) {
                        alert('No route found.');
                        return;
                    }
                    if (routePolyline) {
                        map.removeLayer(routePolyline);
                    }
                    let route = data.route;
                    let i = 1;
                    let segmentCounts = {};
                    function segmentKey(a, b) {
                        return a[0] + ',' + a[1] + '|' + b[0] + ',' + b[1];
                    }
                    routePolyline = L.polyline([route[0]], {color: '#d1001f', weight: 10, opacity: 1.0}).addTo(map);
                    map.fitBounds(L.polyline(route, {weight:1}).getBounds());
                    function animateRoute() {
                        if (i >= route.length) {
                            document.getElementById('view-directions-btn').style.display = '';
                            return;
                        }
                        let prev = route[i-1];
                        let curr = route[i];
                        let key = segmentKey(prev, curr);
                        let revKey = segmentKey(curr, prev);
                        segmentCounts[key] = (segmentCounts[key] || 0) + 1;
                        segmentCounts[revKey] = segmentCounts[key];
                        let color = segmentCounts[key] > 1 ? '#0074D9' : '#d1001f';
                        L.polyline([prev, curr], {color: color, weight: 10, opacity: 1.0}).addTo(map);
                        routePolyline.addLatLng(curr);
                        i++;
                        setTimeout(animateRoute, 150);
                    }
                    animateRoute();
                })
                .catch(err => {
                    hideSpinner();
                    if (err) console.error(err);
                });
        };

        document.getElementById('view-directions-btn').onclick = function() {
            window.location.href = `/result?boundary_id=${boundaryId}&start_node=${startNodeId}`;
        };

        function showCredits(event) {
            event.preventDefault();
            document.getElementById('creditsModal').style.display = 'flex';
        }

        function closeCredits() {
            document.getElementById('creditsModal').style.display = 'none';
        }

        document.getElementById('creditsModal').addEventListener('click', function(e) {
            if (e.target === this) closeCredits();
        });
    </script>
</body>
</html>
